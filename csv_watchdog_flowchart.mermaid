flowchart TD
    A[ðŸš€ Script Start] --> B[âš™ï¸ Load Configuration]
    B --> C[ðŸ“ Setup Logging]
    C --> D[ðŸ“ Create Directories]
    D --> E[ðŸ” Parse CLI Arguments]
    E --> F[ðŸŽ¯ Create Monitor Instance]
    
    F --> G[ðŸ“‚ Scan Watch Directory]
    G --> H{ðŸ“„ CSV Files Found?}
    H -->|No| Z[âœ… Complete - No Files]
    H -->|Yes| I[ðŸ§® Calculate MD5 Checksums]
    
    I --> J[â³ Wait for Stability]
    J --> K[ðŸ§® Recalculate MD5 Checksums]
    K --> L{ðŸ”„ Checksums Match?}
    L -->|No| M[âš ï¸ File Unstable - Skip]
    L -->|Yes| N[âœ… File is Stable]
    
    M --> G
    N --> O[ðŸ§ª Validate UTF-8 Encoding]
    O --> P{ðŸ”¤ Valid Encoding?}
    P -->|No| Q[âŒ Encoding Error - Skip File]
    P -->|Yes| R[ðŸ“Š Load CSV with Pandas]
    
    Q --> G
    R --> S{ðŸ“‹ CSV Load Success?}
    S -->|No| T[âŒ CSV Parse Error - Skip File]
    S -->|Yes| U[ðŸ” Validate DataFrame]
    
    T --> G
    U --> V{âœ… DataFrame Valid?}
    V -->|No| W[âŒ Validation Error - Skip File]
    V -->|Yes| X[ðŸ”’ Acquire File Lock]
    
    W --> G
    X --> Y{ðŸ”“ Lock Acquired?}
    Y -->|No| AA[âŒ Lock Timeout - Skip File]
    Y -->|Yes| BB[ðŸ“„ Check if Merged File Exists]
    
    AA --> G
    BB --> CC{ðŸ“Š Merged File Exists?}
    CC -->|No| DD[ðŸ“‹ Create Empty Base DataFrame]
    CC -->|Yes| EE[ðŸ“Š Load Existing Merged File]
    
    DD --> FF[ðŸ”— Align Column Schemas]
    EE --> GG{ðŸ“Š Load Success?}
    GG -->|No| DD
    GG -->|Yes| FF
    
    FF --> HH[ðŸŽ¯ Identify New Keys]
    HH --> II[ðŸ—‘ï¸ Remove Existing Records with Same Keys]
    II --> JJ[âž• Concatenate Old + New Data]
    JJ --> KK[ðŸ§¹ Check for Obsolete Columns]
    
    KK --> LL{ðŸ” Obsolete Columns Found?}
    LL -->|Yes| MM[ðŸ—‘ï¸ Drop Obsolete Columns]
    LL -->|No| NN[ðŸ’¾ Prepare Final DataFrame]
    MM --> NN
    
    NN --> OO{ðŸ§ª Dry Run Mode?}
    OO -->|Yes| PP[ðŸ“ Log Dry Run Results]
    OO -->|No| QQ[ðŸ’¾ Write to Temporary File]
    
    PP --> SS[ðŸ”“ Release File Lock]
    QQ --> RR[âš¡ Atomic Replace Merged File]
    RR --> TT[ðŸ“„ Save Metadata JSON]
    TT --> UU[ðŸ“¦ Archive Original File]
    UU --> SS
    
    SS --> VV{ðŸ“‚ More Files to Process?}
    VV -->|Yes| G
    VV -->|No| WW[ðŸ“Š Log Processing Summary]
    WW --> XX[âœ… Script Complete]
    
    %% Error Handling Paths
    style Q fill:#ffcccc
    style T fill:#ffcccc
    style W fill:#ffcccc
    style AA fill:#ffcccc
    
    %% Success Paths
    style XX fill:#ccffcc
    style Z fill:#ccffcc
    
    %% Process Steps
    style X fill:#cceeff
    style QQ fill:#cceeff
    style RR fill:#cceeff
    
    %% Validation Steps
    style O fill:#ffffcc
    style U fill:#ffffcc
    style V fill:#ffffcc